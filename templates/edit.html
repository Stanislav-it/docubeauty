<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel edycji</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css', v=static_version) }}">
</head>
<body>
  <main class="main admin">
    <section class="container">
      {% if not logged_in %}
        <div class="admin-login-card">
          <h1 class="h1">Panel edycji</h1>
          <p class="muted">
            Zaloguj się, aby edytować ceny i opisy produktów.
          </p>

          {% if login_error %}
            <div class="notice notice--error">{{ login_error }}</div>
          {% endif %}

          <form method="post" class="admin-login">
            <div class="form-row">
              <label class="form-label" for="username">Login</label>
              <input class="form-input" id="username" type="text" name="username" autocomplete="username" required>
            </div>
            <div class="form-row">
              <label class="form-label" for="password">Hasło</label>
              <input class="form-input" id="password" type="password" name="password" autocomplete="current-password" required>
            </div>
            <button class="btn" type="submit">Zaloguj</button>
          </form>
        </div>

      {% else %}

        <!-- Top bar: ONLY search + back to shop -->
        <header class="edit-topbar edit-topbar--simple">
          <div class="edit-topbar__search">
            <div class="edit-search-pill" role="search" aria-label="Wyszukiwanie">
              <span class="edit-search-pill__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </span>

              <label class="sr-only" for="adminSearch">Szukaj</label>
              <input class="edit-search-pill__input" id="adminSearch" type="search" placeholder="Szukaj produktów lub kategorii…" autocomplete="off">

              <div class="edit-search-suggest" id="adminSearchSuggest" role="listbox" aria-label="Podpowiedzi" hidden></div>
            </div>
          </div>
          <div class="edit-topbar__actions">
            <button class="btn" type="button" id="saveAllBtn">Zapisz wszystko</button>
            <a class="btn btn--secondary" href="{{ url_for('download_data') }}">Pobierz dane</a>
            <a class="btn btn--secondary" href="{{ url_for('shop') }}">Wróć do sklepu</a>
          </div>
        </header>

        <div class="admin-notices">
          {% if product_saved %}
            <div class="notice notice--ok">Zapisano zmiany w produkcie.</div>
          {% endif %}
          {% if saved %}
            <div class="notice notice--ok">Gotowe. Zapisano zmiany.</div>
          {% endif %}
          {% if added %}
            <div class="notice notice--ok">Dodano nowy produkt.</div>
          {% endif %}
          {% if added_category %}
            <div class="notice notice--ok">Dodano nową kategorię.</div>
          {% endif %}
          {% if deleted_category %}
            <div class="notice notice--ok">Usunięto kategorię.</div>
          {% endif %}
          {% if deleted_product %}
            <div class="notice notice--ok">Usunięto produkt.</div>
          {% endif %}
          {% if photo_updated %}
            <div class="notice notice--ok">Zaktualizowano zdjęcie produktu.</div>
          {% endif %}
          {% if error_message %}
            <div class="notice notice--error">{{ error_message }}</div>
          {% endif %}
          {% if add_error %}
            <div class="notice notice--error">{{ add_error }}</div>
          {% endif %}
        </div>

        <!-- Add category (top) -->
        <section class="admin-panel admin-panel--addcat-top">
          <div class="panel">
            <div class="panel__body">
              <form method="post" class="add-category">
                <input type="hidden" name="action" value="add_category">
                <label class="sr-only" for="newCategoryName">Nazwa kategorii</label>
                <input class="form-input" id="newCategoryName" type="text" name="category_name" required placeholder="Nowa kategoria…" style="flex: 1 1 320px; min-width: 240px;">
                <button class="btn" type="button" data-queue-add-category>Dodaj kategorię</button>
              </form>
                <div class="queued-chips" id="queuedCategories" aria-label="Zmiany do zapisania"></div>
            </div>
          </div>
        </section>

        <!-- Categories -->
        <section class="admin-content admin-content--flat" id="adminContent">

          <div class="admin-hint">
            <div class="muted">
              Wszystkie zmiany (nazwy, opisy, ceny, zdjęcia, dodawanie/usuwanie) zapisujesz jednym przyciskiem „Zapisz wszystko” na górze.
            </div>
          </div>

          <div class="category-list" data-category-list>
            {% for cat_name, products, cat_thumb_url, cat_docu_slug in groups %}
              <details class="cat-card" data-cat-card id="cat-{{ loop.index }}">
                <summary class="cat-card__summary">
                  <div class="cat-card__left">
                    <!-- Category thumbnail + upload (preview like product cards) -->
                    <div class="cat-thumb" data-cat-thumb>
                      {% if cat_thumb_url %}
                        <img src="{{ cat_thumb_url }}" alt="" class="cat-thumb__img">
                      {% else %}
                        <div class="cat-thumb__img cat-thumb__img--empty">Brak zdjęcia</div>
                      {% endif %}

                      <form method="post" enctype="multipart/form-data" class="cat-photo cat-photo--under" data-stop-summary data-cat-photo>
                        <input type="hidden" name="action" value="cat_photo">
                        {% if cat_docu_slug %}
                          <input type="hidden" name="cat_slug" value="{{ cat_docu_slug }}">
                        {% else %}
                          <input type="hidden" name="cat_name" value="{{ cat_name }}">
                        {% endif %}
                        <input class="file-hidden" type="file" name="photo" id="catphoto_{{ loop.index }}" accept="image/*" required>

                        <div class="file-row file-row--under">
                          <label class="btn btn--small btn--secondary" for="catphoto_{{ loop.index }}" data-stop-summary>Zmień zdjęcie</label>
                          <span class="file-name" data-file-name>Nie wybrano pliku</span>
                          <span class="edit-photo-queued" data-photo-queued hidden>Do zapisania</span>
                        </div>
                      </form>
                    </div>

                    <div class="cat-card__title">
                      <!-- Editable category name: auto-save on blur/Enter (no button) -->
                      <form method="post" class="cat-rename" data-cat-rename>
                        <input type="hidden" name="action" value="cat_rename">
                        <input type="hidden" name="old_name" value="{{ cat_name }}">
                        <input
                          class="cat-card__name-input"
                          type="text"
                          name="new_name"
                          value="{{ cat_name }}"
                          autocomplete="off"
                          required
                          data-cat-input
                          aria-label="Nazwa kategorii"
                        >
                        <span class="edit-dirty-flag" data-cat-dirty hidden>Niezapisane zmiany</span>
                      </form>
                      <span class="badge">{{ products|length }}</span>
                    </div>
                  </div>

                  <div class="cat-card__right">
                    <div class="cat-card__meta muted">Kliknij, aby rozwinąć</div>

                    <button class="btn btn--small" type="button" data-stop-summary data-add-product-btn>Dodaj produkt</button>

                    <form method="post" class="inline-form" data-stop-summary data-confirm="Usunąć kategorię „{{ cat_name }}”?">
                      <input type="hidden" name="action" value="cat_delete">
                      <input type="hidden" name="name" value="{{ cat_name }}">
                      <button class="btn btn--small btn--danger" type="button" data-queue-delete-cat>Usuń kategorię</button>
                    </form>
                  </div>
                </summary>

                <div class="cat-card__body">

                  <div class="cat-add" data-cat-add style="display:none; margin:12px 0 16px; padding:14px; border:1px solid rgba(0,0,0,.08); border-radius:14px; background:rgba(0,0,0,.02);">
                    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px;">
                      <div style="font-weight:600;">Dodaj produkt do tej kategorii</div>
                      <button class="btn btn--small btn--secondary" type="button" data-cat-add-cancel>Zamknij</button>
                    </div>

                    <form method="post" enctype="multipart/form-data" class="add-product-inline">
                      <input type="hidden" name="action" value="add_product">
                      <input type="hidden" name="new_category" value="{{ cat_name }}">

                      <div class="products-grid products-grid--add">
                        <label class="edit-field" style="grid-column: 1 / -1;">
                          <div class="edit-field__label">Nazwa produktu</div>
                          <input class="form-input" type="text" name="new_title" required placeholder="Np. Zabieg – pakiet dokumentacji">
                        </label>

                        <label class="edit-field">
                          <div class="edit-field__label">Zdjęcie (miniatura)</div>
                          <input class="form-input" type="file" name="new_photo" accept="image/*" required>
                        </label>

                        <label class="edit-field">
                          <div class="edit-field__label">Plik (PDF / ZIP / DOCX itp.)</div>
                          <input class="form-input" type="file" name="new_file" required>
                        </label>

                        <label class="edit-field" style="grid-column: 1 / -1;">
                          <div class="edit-field__label">Opis</div>
                          <textarea class="form-input" name="new_description" rows="4" placeholder="Opis produktu..."></textarea>
                        </label>

                        <label class="edit-field" style="max-width:240px;">
                          <div class="edit-field__label">Cena (PLN)</div>
                          <input class="form-input" type="text" name="new_price" required placeholder="Np. 49.99" inputmode="decimal">
                        </label>

                        <div style="display:flex; align-items:flex-end; gap:10px;">
                          <button class="btn" type="button" data-queue-add-product>Dodaj produkt</button>
                        </div>
                      </div>
                    </form>
                  </div>

                  <div class="queued-list" data-queued-products></div>

                  {% if products|length == 0 %}
                    <div class="muted" style="padding:12px 0;">Brak produktów w tej kategorii.</div>
                  {% else %}
                    <div class="products-grid">
                      {% for p in products %}
                        <article class="prod-card" id="prod_{{ p.id|replace(':','_') }}" data-prod-card data-search="{{ (cat_name ~ ' ' ~ p.title ~ ' ' ~ (p.description or '') )|lower }}">
                          <div class="prod-card__media">
                            {% if p.photo_url %}
                              <img src="{{ p.photo_url }}" alt="" class="prod-card__img">
                            {% else %}
                              <div class="prod-card__img prod-card__img--empty">Brak zdjęcia</div>
                            {% endif %}

                            <!-- Photo update (button directly under thumbnail; saved via "Zapisz wszystko") -->
                            <form method="post" enctype="multipart/form-data" class="product-photo product-photo--under" data-photo-form>
                              <input type="hidden" name="action" value="product_photo">
                              <input type="hidden" name="product_id" value="{{ p.id }}">

                              {% set pid = p.id|replace(':','_') %}
                              <input class="file-hidden" type="file" name="photo" id="photo_{{ pid }}" accept="image/*" required>

                              <div class="file-row file-row--under">
                                <label class="btn btn--small btn--secondary" for="photo_{{ pid }}" data-stop-summary>Zmień zdjęcie</label>
                                <span class="file-name" data-file-name>Nie wybrano pliku</span>
                                <span class="edit-photo-queued" data-photo-queued hidden>Do zapisania</span>
                              </div>
                            </form>
                          </div>

                          <div class="prod-card__body">
                            <div class="prod-card__head">
                              <!-- Per-product save form (no bulk chaos) -->
                              <form method="post" class="prod-edit" id="prodForm_{{ p.id|replace(':','_') }}">
                                <input type="hidden" name="action" value="product_update">
                                <input type="hidden" name="product_id" value="{{ p.id }}">

                                <input
                                  class="prod-card__title-input"
                                  type="text"
                                  name="title"
                                  value="{{ p.title }}"
                                  autocomplete="off"
                                  required
                                  aria-label="Nazwa produktu"
                                >

                                <label class="edit-field">
                                  <div class="edit-field__label">Opis</div>
                                  <textarea class="form-input" name="description" rows="3">{{ p.description or p.title }}</textarea>
                                </label>

                                <div class="prod-edit__row">
                                  <label class="edit-field prod-edit__price">
                                    <div class="edit-field__label">Cena</div>
                                    <div class="edit-row__price-wrap">
                                      <input class="form-input" type="text" name="price" value="{{ '%.2f'|format(p.price_pln) }}" inputmode="decimal">
                                      <span class="edit-row__currency">zł</span>
                                    </div>
                                  </label>

                                  <div class="prod-edit__save">
                                    <span class="edit-dirty-flag" data-dirty-flag hidden>Niezapisane zmiany</span>
                                  </div>
                                </div>
                              </form>

                              <form method="post" class="inline-form" data-confirm="Usunąć produkt „{{ p.title }}”?">
                                <input type="hidden" name="action" value="product_delete">
                                <input type="hidden" name="product_id" value="{{ p.id }}">
                                <button class="btn btn--small btn--secondary" type="button" data-queue-delete>Usuń</button>
                              </form>
                            </div></div>
                        </article>
                      {% endfor %}
                    </div>
                  {% endif %}

                </div>
              </details>
            {% endfor %}
          </div>

          <!-- Options -->
          <section class="admin-panel admin-panel--options">
            <div class="panel">
              <div class="panel__body">
                <form method="post" class="logout-row">
                  <input type="hidden" name="action" value="logout">
                  <button class="btn btn--secondary" type="submit">Wyloguj</button>
                </form>
              </div>
            </div>
          </section>


        </section>

      {% endif %}
    </section>
  </main>

<script>
(function(){
  const notices = document.querySelector('.admin-notices');
  const saveAllBtn = document.getElementById('saveAllBtn');

  function showNotice(kind, msg){
    if(!notices) return;
    const div = document.createElement('div');
    div.className = 'notice ' + (kind === 'error' ? 'notice--error' : 'notice--ok');
    div.textContent = msg;
    notices.prepend(div);
    window.setTimeout(() => div.remove(), 8000);
  }

  // Prevent toggling <details> when clicking controls inside <summary>
  document.querySelectorAll('[data-stop-summary]').forEach((el) => {
    el.addEventListener('click', (e) => e.stopPropagation());
    el.addEventListener('mousedown', (e) => e.stopPropagation());
  });

  // Prevent accidental form submits (we use
  // single 'Zapisz wszystko'
  document.querySelectorAll('form.prod-edit, form.product-photo, form[data-cat-photo], form.cat-rename, form.add-category, form.add-product-inline').forEach((f) => {
    f.addEventListener('submit', (e) => e.preventDefault());
  });



  // ----------------------
  // Add product panel toggle
  // ----------------------
  document.querySelectorAll('[data-add-product-btn]').forEach((btn) => {
    const details = btn.closest('details');
    if(!details) return;
    const panel = details.querySelector('[data-cat-add]');
    if(!panel) return;
    const cancel = panel.querySelector('[data-cat-add-cancel]');

    function toggle(open){
      details.open = true;
      panel.style.display = (open === undefined) ? (panel.style.display === 'none' ? 'block' : 'none') : ((open ? 'block' : 'none'));
      if(panel.style.display !== 'none'){
        const first = panel.querySelector('input, textarea, select');
        if(first) first.focus({preventScroll:false});
      }
    }

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggle(undefined);
    });

    if(cancel){
      cancel.addEventListener('click', (e) => {
        e.preventDefault();
        panel.style.display = 'none';
      });
    }
  });

  // ----------------------
  // Dirty tracking (products)
  // ----------------------
  const prodForms = Array.from(document.querySelectorAll('form.prod-edit'));
  for(const f of prodForms){
    const card = f.closest('.prod-card');
    if(!card) continue;

    const title = f.querySelector('input[name="title"]');
    const desc = f.querySelector('textarea[name="description"]');
    const price = f.querySelector('input[name="price"]');
    const flag = f.querySelector('[data-dirty-flag]');

    f.dataset.initialTitle = title ? title.value : '';
    f.dataset.initialDesc = desc ? desc.value : '';
    f.dataset.initialPrice = price ? price.value : '';

    const mark = () => {
      const dirty = (
        (title && title.value !== f.dataset.initialTitle) ||
        (desc && desc.value !== f.dataset.initialDesc) ||
        (price && price.value !== f.dataset.initialPrice)
      );
      card.classList.toggle('is-dirty', !!dirty);
      if(flag) flag.hidden = !dirty;
      f.dataset.dirty = dirty ? '1' : '';
    };

    [title, desc, price].filter(Boolean).forEach((el) => {
      el.addEventListener('input', mark);
      el.addEventListener('change', mark);
    });
    mark();
  }

  // ----------------------
  // Dirty tracking (category rename)
  // ----------------------
  const catRenameForms = Array.from(document.querySelectorAll('[data-cat-rename]'));
  for(const f of catRenameForms){
    const input = f.querySelector('[data-cat-input]');
    const oldName = f.querySelector('input[name="old_name"]');
    const flag = f.querySelector('[data-cat-dirty]');
    if(!input || !oldName) continue;

    const mark = () => {
      const dirty = (input.value || '').trim() !== (oldName.value || '').trim();
      if(flag) flag.hidden = !dirty;
      f.dataset.dirty = dirty ? '1' : '';
    };

    input.addEventListener('click', (e) => e.stopPropagation());
    input.addEventListener('keydown', (e) => e.stopPropagation());
    input.addEventListener('input', mark);
    input.addEventListener('change', mark);
    mark();
  }

  // ----------------------
  // Photo queues (product + category)
  // ----------------------
  function setupPhotoQueue(form){
    const file = form.querySelector('input[type="file"]');
    const name = form.querySelector('[data-file-name]');
    const queued = form.querySelector('[data-photo-queued]');
    if(!file) return;

    file.addEventListener('change', () => {
      const f0 = (file.files && file.files[0]) ? file.files[0] : null;
      // Instant preview for product thumbnails
      try{
        const prodCard = form.closest('.prod-card');
        if(prodCard){
          const media = prodCard.querySelector('.prod-card__media');
          if(media){
            // Revoke previous preview URL (avoid memory leaks)
            if(form.dataset.previewUrl){
              try{ URL.revokeObjectURL(form.dataset.previewUrl); }catch(e){}
              delete form.dataset.previewUrl;
            }
            if(f0){
              const url = URL.createObjectURL(f0);
              form.dataset.previewUrl = url;
              let img = media.querySelector('img.prod-card__img');
              const empty = media.querySelector('.prod-card__img--empty');
              if(!img){
                img = document.createElement('img');
                img.className = 'prod-card__img';
                img.alt = '';
                if(empty){ empty.replaceWith(img); }
                else{ media.prepend(img); }
              }
              img.src = url;
            }
          }
        }
      }catch(e){}

      // Instant preview for category thumbnails
      try{
        const catCard = form.closest('.cat-card');
        if(catCard && !form.closest('.prod-card')){
          const thumb = catCard.querySelector('[data-cat-thumb]');
          if(thumb){
            if(form.dataset.previewUrl){
              try{ URL.revokeObjectURL(form.dataset.previewUrl); }catch(e){}
              delete form.dataset.previewUrl;
            }
            if(f0){
              const url = URL.createObjectURL(f0);
              form.dataset.previewUrl = url;
              let img = thumb.querySelector('img.cat-thumb__img');
              const empty = thumb.querySelector('.cat-thumb__img--empty');
              if(!img){
                img = document.createElement('img');
                img.className = 'cat-thumb__img';
                img.alt = '';
                if(empty){ empty.replaceWith(img); }
                else{ thumb.prepend(img); }
              }
              img.src = url;
            }
          }
        }
      }catch(e){}
      if(name) name.textContent = f0 ? f0.name : 'Nie wybrano pliku';
      if(queued) queued.hidden = !f0;
      form.dataset.queued = f0 ? '1' : '';

      const card = form.closest('.prod-card, .cat-card');
      if(card) card.classList.toggle('is-dirty', !!f0 || card.classList.contains('is-dirty'));
    });
  }

  document.querySelectorAll('[data-photo-form], [data-cat-photo]').forEach(setupPhotoQueue);

  // ----------------------
  // Queue: add categories
  // ----------------------
  const queuedCategories = [];
  const addCatBtn = document.querySelector('[data-queue-add-category]');
  const addCatInput = document.getElementById('newCategoryName');
  const catChips = document.getElementById('queuedCategories');

  function renderCatChips(){
    if(!catChips) return;
    catChips.innerHTML = '';
    for(const name of queuedCategories){
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      chip.textContent = name + '  ×';
      chip.addEventListener('click', () => {
        const i = queuedCategories.indexOf(name);
        if(i>=0) queuedCategories.splice(i,1);
        renderCatChips();
      });
      catChips.appendChild(chip);
    }
  }

  if(addCatBtn && addCatInput){
    addCatBtn.addEventListener('click', () => {
      const name = (addCatInput.value || '').trim();
      if(!name) return;
      if(!queuedCategories.some((c) => c.toLowerCase() === name.toLowerCase())){
        queuedCategories.push(name);
      }
      addCatInput.value = '';
      renderCatChips();
      showNotice('ok', 'Dodano kategorię do kolejki. Kliknij „Zapisz wszystko”.');
    });
  }

  // ----------------------
  // Queue: add products
  // ----------------------
  const queuedProducts = [];

  function renderQueuedProducts(catCard){
    const box = catCard.querySelector('[data-queued-products]');
    if(!box) return;
    const catName = (catCard.querySelector('[data-cat-input]')?.value || '').trim();
    const items = queuedProducts.filter((x) => x.categoryKey === catCard.id);

    box.innerHTML = '';
    if(items.length === 0) return;

    const title = document.createElement('div');
    title.className = 'queued-title';
    title.textContent = 'Do dodania (' + items.length + '):';
    box.appendChild(title);

    for(const item of items){
      const row = document.createElement('div');
      row.className = 'queued-row';
      row.innerHTML = `<div class="queued-main">${escapeHtml(item.title)} <span class="queued-muted">(${escapeHtml(catName)})</span></div>`;
      const rm = document.createElement('button');
      rm.type = 'button';
      rm.className = 'btn btn--small btn--secondary';
      rm.textContent = 'Usuń z kolejki';
      rm.addEventListener('click', () => {
        const i = queuedProducts.indexOf(item);
        if(i>=0) queuedProducts.splice(i,1);
        renderQueuedProducts(catCard);
      });
      row.appendChild(rm);
      box.appendChild(row);
    }
  }

  document.querySelectorAll('details.cat-card').forEach((catCard) => {
    const btn = catCard.querySelector('[data-queue-add-product]');
    if(!btn) return;
    btn.addEventListener('click', () => {
      const form = btn.closest('form.add-product-inline');
      if(!form) return;
      const title = (form.querySelector('input[name="new_title"]')?.value || '').trim();
      const desc = (form.querySelector('textarea[name="new_description"]')?.value || '').trim();
      const priceRaw = (form.querySelector('input[name="new_price"]')?.value || '').trim();
      const photo = form.querySelector('input[name="new_photo"]')?.files?.[0] || null;
      const file = form.querySelector('input[name="new_file"]')?.files?.[0] || null;
      const category = (form.querySelector('input[name="new_category"]')?.value || '').trim() || 'Produkty';

      function normPrice(s){
        return String(s || '')
          .replaceAll('zł','')
          .replaceAll('ZŁ','')
          .replaceAll(' ','')
          .replaceAll(',','.');
      }
      const priceNum = parseFloat(normPrice(priceRaw));

      // Light client-side validation to prevent "wszystko wypełnione" confusion.
      if(!title){
        showNotice('error', 'Brak nazwy produktu.');
        return;
      }
      if(!priceRaw || !(priceNum > 0)){
        showNotice('error', 'Nieprawidłowa cena (musi być większa niż 0).');
        return;
      }
      if(!photo){
        showNotice('error', 'Brak zdjęcia produktu.');
        return;
      }
      if(!file){
        showNotice('error', 'Brak pliku produktu (PDF/ZIP/DOCX itd.).');
        return;
      }

      queuedProducts.push({
        categoryKey: catCard.id,
        category,
        title,
        desc,
        price: priceRaw,
        photo,
        file,
      });

      // reset form
      form.reset();
      renderQueuedProducts(catCard);
      showNotice('ok', 'Dodano produkt do kolejki. Kliknij „Zapisz wszystko”.');
    });
  });

  // ----------------------
  // Queue: deletions (product/category)
  // ----------------------
  const deleteProducts = new Set();
  const deleteCategories = new Set();

  document.querySelectorAll('[data-queue-delete]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const form = btn.closest('form');
      const pid = form?.querySelector('input[name="product_id"]')?.value || '';
      const card = btn.closest('.prod-card');
      if(!pid || !card) return;

      if(card.classList.contains('is-pending-delete')){
        card.classList.remove('is-pending-delete');
        deleteProducts.delete(pid);
        btn.textContent = 'Usuń';
        return;
      }

      const msg = form.getAttribute('data-confirm') || 'Usunąć produkt?';
      if(!confirm(msg)) return;

      card.classList.add('is-pending-delete');
      deleteProducts.add(pid);
      btn.textContent = 'Cofnij';
    });
  });

  document.querySelectorAll('[data-queue-delete-cat]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const form = btn.closest('form');
      const name = form?.querySelector('input[name="name"]')?.value || '';
      const card = btn.closest('.cat-card');
      if(!name || !card) return;

      if(card.classList.contains('is-pending-delete')){
        card.classList.remove('is-pending-delete');
        deleteCategories.delete(name);
        btn.textContent = 'Usuń kategorię';
        return;
      }

      const msg = form.getAttribute('data-confirm') || 'Usunąć kategorię?';
      if(!confirm(msg)) return;

      card.classList.add('is-pending-delete');
      deleteCategories.add(name);
      btn.textContent = 'Cofnij';
    });
  });

  // ----------------------
  // SAVE ALL
  // ----------------------
  async function postAction(fd){
    fd.append('ajax','1');
    const res = await fetch('/edit', { method: 'POST', body: fd, credentials: 'same-origin' });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || !data.ok){
      throw new Error(data.error || 'Błąd zapisu');
    }
    return data;
  }

  async function saveAll(){
    if(!saveAllBtn) return;

    saveAllBtn.disabled = true;
    const prev = saveAllBtn.textContent;
    saveAllBtn.textContent = 'Zapisywanie…';

    try{
      let any = false;

      // 1) add categories
      for(const name of queuedCategories){
        any = true;
        const fd = new FormData();
        fd.append('action','add_category');
        fd.append('category_name', name);
        await postAction(fd);
      }

      // 2) category renames
      for(const f of catRenameForms){
        if(f.dataset.dirty !== '1') continue;
        any = true;
        const oldName = f.querySelector('input[name="old_name"]')?.value || '';
        const newName = f.querySelector('input[name="new_name"]')?.value || '';
        const fd = new FormData();
        fd.append('action','cat_rename');
        fd.append('old_name', oldName);
        fd.append('new_name', newName);
        await postAction(fd);
      }

      // 3) category photos
      for(const f of document.querySelectorAll('[data-cat-photo]')){
        if(f.dataset.queued !== '1') continue;
        any = true;
        const file = f.querySelector('input[type="file"]')?.files?.[0];
        if(!file) continue;
        const fd = new FormData();
        fd.append('action','cat_photo');
        const slug = f.querySelector('input[name="cat_slug"]')?.value || '';
        const name = f.querySelector('input[name="cat_name"]')?.value || '';
        if(slug) fd.append('cat_slug', slug);
        if(name) fd.append('cat_name', name);
        fd.append('photo', file);
        await postAction(fd);
      }

      // 4) add products
      for(const item of queuedProducts){
        any = true;
        const fd = new FormData();
        fd.append('action','add_product');
        fd.append('new_category', item.category);
        fd.append('new_title', item.title);
        fd.append('new_description', item.desc);
        fd.append('new_price', item.price);
        fd.append('new_photo', item.photo);
        fd.append('new_file', item.file);
        await postAction(fd);
      }

      // 5) product updates
      for(const f of prodForms){
        if(f.dataset.dirty !== '1') continue;
        any = true;
        const pid = f.querySelector('input[name="product_id"]')?.value || '';
        const fd = new FormData();
        fd.append('action','product_update');
        fd.append('product_id', pid);
        fd.append('title', f.querySelector('input[name="title"]')?.value || '');
        fd.append('description', f.querySelector('textarea[name="description"]')?.value || '');
        fd.append('price', f.querySelector('input[name="price"]')?.value || '');
        await postAction(fd);
      }

      // 6) product photos
      for(const f of document.querySelectorAll('[data-photo-form]')){
        if(f.dataset.queued !== '1') continue;
        any = true;
        const pid = f.querySelector('input[name="product_id"]')?.value || '';
        const file = f.querySelector('input[type="file"]')?.files?.[0];
        if(!pid || !file) continue;
        const fd = new FormData();
        fd.append('action','product_photo');
        fd.append('product_id', pid);
        fd.append('photo', file);
        await postAction(fd);
      }

      // 7) delete products
      for(const pid of Array.from(deleteProducts)){
        any = true;
        const fd = new FormData();
        fd.append('action','product_delete');
        fd.append('product_id', pid);
        await postAction(fd);
      }

      // 8) delete categories
      for(const name of Array.from(deleteCategories)){
        any = true;
        const fd = new FormData();
        fd.append('action','cat_delete');
        fd.append('name', name);
        await postAction(fd);
      }

      if(!any){
        showNotice('ok', 'Brak zmian do zapisania.');
        return;
      }

      window.location.assign('/edit?saved=1');
    } catch(err){
      showNotice('error', String(err && err.message ? err.message : err));
    } finally {
      saveAllBtn.disabled = false;
      saveAllBtn.textContent = prev;
    }
  }

  if(saveAllBtn){
    saveAllBtn.addEventListener('click', saveAll);
  }

  // ----------------------
  // Search suggestions (only подсказки)
  // ----------------------
  const input = document.getElementById('adminSearch');
  const suggest = document.getElementById('adminSearchSuggest');
  if(input && suggest){
    const catCards = Array.from(document.querySelectorAll('[data-cat-card]'));
    const prodCards = Array.from(document.querySelectorAll('[data-prod-card]'));

    function norm(s){ return String(s || '').trim().toLowerCase(); }

    function getCatName(catEl){
      const nameInput = catEl.querySelector('[data-cat-input]');
      return (nameInput ? nameInput.value : '') || '';
    }

    function getProdTitle(prodEl){
      const t = prodEl.querySelector('.prod-card__title-input');
      return (t ? t.value : '') || '';
    }

    function getProdCategory(prodEl){
      const catEl = prodEl.closest('[data-cat-card]');
      return catEl ? getCatName(catEl) : '';
    }

    function hideSuggest(){ suggest.hidden = true; suggest.innerHTML = ''; }
    function openSuggest(){ suggest.hidden = false; }

    function renderGroup(label, itemsHtml){
      if(!itemsHtml) return '';
      return `
        <div class="edit-suggest__group">
          <div class="edit-suggest__label">${label}</div>
          <div class="edit-suggest__items">${itemsHtml}</div>
        </div>
      `;
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function flash(el){
      el.classList.add('is-flash');
      window.setTimeout(() => el.classList.remove('is-flash'), 1100);
    }

    function render(q){
      const query = norm(q);
      if(!query){ hideSuggest(); return; }

      const catMatches = [];
      for(const c of catCards){
        const name = getCatName(c);
        if(norm(name).includes(query)) catMatches.push({name, el:c});
      }

      const prodMatches = [];
      for(const p of prodCards){
        const hay = norm(p.getAttribute('data-search') || '') + ' ' + norm(getProdTitle(p));
        if(hay.includes(query)){
          prodMatches.push({ title: getProdTitle(p), category: getProdCategory(p), el: p });
        }
      }

      const maxPerGroup = 8;
      const catsHtml = catMatches.slice(0, maxPerGroup).map((m) => {
        const id = m.el.id;
        return `<button type="button" class="edit-suggest__item" data-kind="cat" data-target="${id}">
          <span class="edit-suggest__main">${escapeHtml(m.name)}</span>
        </button>`;
      }).join('');

      const prodsHtml = prodMatches.slice(0, maxPerGroup).map((m) => {
        const id = m.el.id;
        return `<button type="button" class="edit-suggest__item" data-kind="prod" data-target="${id}">
          <span class="edit-suggest__main">${escapeHtml(m.title || '—')}</span>
          <span class="edit-suggest__meta">${escapeHtml(m.category || '')}</span>
        </button>`;
      }).join('');

      const html = renderGroup('Kategorie', catsHtml) + renderGroup('Produkty', prodsHtml);
      if(!html.trim()){ hideSuggest(); return; }
      suggest.innerHTML = html;
      openSuggest();
    }

    suggest.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-kind][data-target]');
      if(!btn) return;

      const kind = btn.getAttribute('data-kind');
      const targetId = btn.getAttribute('data-target');
      const target = targetId ? document.getElementById(targetId) : null;
      if(!target) return;

      if(kind === 'cat'){
        target.open = true;
        target.scrollIntoView({behavior:'smooth', block:'start'});
        const inp = target.querySelector('[data-cat-input]');
        if(inp) window.setTimeout(() => inp.focus({preventScroll:true}), 250);
      } else {
        const cat = target.closest('[data-cat-card]');
        if(cat) cat.open = true;
        target.scrollIntoView({behavior:'smooth', block:'center'});
        flash(target);
        const title = target.querySelector('.prod-card__title-input');
        if(title) window.setTimeout(() => title.focus({preventScroll:true}), 250);
      }

      hideSuggest();
    });

    input.addEventListener('input', () => render(input.value));
    input.addEventListener('focus', () => render(input.value));
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){ hideSuggest(); input.blur(); }
    });

    document.addEventListener('click', (e) => {
      const within = e.target.closest('.edit-search-pill');
      if(!within) hideSuggest();
    });
  }

  function escapeHtml(str){
    return String(str || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }
})();
</script>

</body>
</html>
